e2eTest: &e2eTest
  machine: true
  working_directory: /home/circleci/.go_workspace/src/github.com/giantswarm/azure-operator
  steps:
  - checkout
  - run: |
      wget -q $(curl -sS https://api.github.com/repos/giantswarm/e2e-harness/releases/latest | grep browser_download_url | head -n 1 | cut -d '"' -f 4)
      chmod +x ./e2e-harness
  - run: ./e2e-harness localkube
  - run: ./e2e-harness setup --remote=false
  - run:
      command: ./e2e-harness test --test-dir=${TEST_DIR}
      no_output_timeout: 30m
  - run:
      command: ./e2e-harness teardown
      when: always



version: 2
jobs:
  build:
    machine: true
    environment:
      RUN_IN_DIND: "docker exec -ti systemd-dind"
    steps:
    - run: |
        wget -q $(curl -sS https://api.github.com/repos/giantswarm/e2e-harness/releases/latest | grep browser_download_url | head -n 1 | cut -d '"' -f 4)
        chmod +x ./e2e-harness
    - run: |
        docker run --rm --name systemd-dind -d --privileged -v /sys/fs/cgroup:/sys/fs/cgroup:rw \
          -v /var/lib/dind:/var/lib/docker:rw \
          -v $(readlink -f ~/project):/project:rw \
          quay.io/giantswarm/libvirt-and-docker
    - run: ${RUN_IN_DIND} /project/e2e-harness localkube
    - deploy:
        command: |
          if [ "${CIRCLE_BRANCH}" == "master" ]; then
            ./architect deploy
          fi


  e2eTestCurMasterReady:
    environment:
      TESTED_VERSION: "current"
      TEST_DIR: "integration/test/ready"
    <<: *e2eTest
  e2eTestCurPRReady:
    environment:
      TESTED_VERSION: "current"
      TEST_DIR: "integration/test/ready"
    <<: *e2eTest

#  e2eTestCurMasterScaling:
#    environment:
#      TESTED_VERSION: "current"
#      TEST_DIR: "integration/test/scaling"
#    <<: *e2eTest
#  e2eTestCurPRScaling:
#    environment:
#      TESTED_VERSION: "current"
#      TEST_DIR: "integration/test/scaling"
#    <<: *e2eTest
  e2eTestWIPMasterScaling:
    environment:
      TESTED_VERSION: "wip"
      TEST_DIR: "integration/test/scaling"
    <<: *e2eTest
  e2eTestWIPPRScaling:
    environment:
      TESTED_VERSION: "wip"
      TEST_DIR: "integration/test/scaling"
    <<: *e2eTest



workflows:
  version: 2
  build_and_e2eTest:
    jobs:
      - build
      - hold:
          type: approval
          filters:
            branches:
              ignore: master
          requires:
          - build


      - e2eTestCurPRReady:
          requires:
          - hold
      - e2eTestCurMasterReady:
          filters:
            branches:
              only: master
          requires:
          - build

#      - e2eTestCurPRScaling:
#          requires:
#          - hold
#      - e2eTestCurMasterScaling:
#          filters:
#            branches:
#              only: master
#          requires:
#          - build
      - e2eTestWIPPRScaling:
          requires:
          - hold
      - e2eTestWIPMasterScaling:
          filters:
            branches:
              only: master
          requires:
          - build
