{
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "location": {
            "type": "String"
        },
        "GiantSwarmTags": {
            "type": "object",
            "defaultValue": {
                "provider": "F80D01C0-7AAC-4440-98F6-5061511962AD"
            }
        },
        "vmssName": {
            "type": "string"
        },
        "vmssVmSize": {
            "type": "string"
        },
        "vmssVmCount": {
            "type": "int",
            "minValue": 1,
            "maxValue": 100
        },
        "vmssVmDataDisks": {
            "type": "array"
        },
        "vmssSshUser": {
            "type": "String"
        },
        "vmssSshPublicKey": {
            "type": "String"
        },
        "vmssOsImagePublisher": {
            "type": "string"
        },
        "vmssOsImageOffer": {
            "type": "string"
        },
        "vmssOsImageSKU": {
            "type": "string"
        },
        "vmssOsImageVersion": {
            "type": "string"
        },
        "vmssVmCustomData": {
            "type": "secureString"
        },
        "vmssLbBackendPoolId": {
            "type": "string"
        },
        "vmssVnetSubnetId": {
            "type": "string"
        }
    },
    "variables": {
        "networkApiVersion": "2017-06-01",
        "computeApiVersion": "2017-12-01",

        "vmssResourceId": "[resourceId('Microsoft.Compute/virtualMachineScaleSets', parameters('vmssName'))]",
        "___vmssPipName": "___[concat(parameters('vmssName'), '-pip')]",
        "___vmssPipResourceId": "___[resourceId('Microsoft.Network/publicIpAddresses', variables('vmssPipName'))]",
        "__comment__": "Must be between 1 and 15 characters.",
        "vmssVmNamePrefix": "[toLower(parameters('vmssName'))]",
        "__comment__": "When true this limits the scale set to a single placement group, of max size 100 virtual machines.",
        "vmssSinglePlacementGroup": "true",
        "___vmssLbName": "___[concat(parameters('vmssName'), '-lb')]",
        "___vmssLbResourceId": "___[resourceId('Microsoft.Network/loadBalancers/', variables('vmssLbName'))]",
        "vmssStandardLrsSize": [
            "Standard_A0",
            "Standard_A1",
            "Standard_A10",
            "Standard_A11",
            "Standard_A1_v2",
            "Standard_A2",
            "Standard_A2_v2",
            "Standard_A2m_v2",
            "Standard_A3",
            "Standard_A4",
            "Standard_A4_v2",
            "Standard_A4m_v2",
            "Standard_A5",
            "Standard_A6",
            "Standard_A7",
            "Standard_A8",
            "Standard_A8_v2",
            "Standard_A8m_v2",
            "Standard_A9",
            "Standard_D1",
            "Standard_D11",
            "Standard_D11_v2",
            "Standard_D11_v2_Promo",
            "Standard_D12",
            "Standard_D12_v2",
            "Standard_D12_v2_Promo",
            "Standard_D13",
            "Standard_D13_v2",
            "Standard_D13_v2_Promo",
            "Standard_D14",
            "Standard_D14_v2",
            "Standard_D14_v2_Promo",
            "Standard_D15_v2",
            "Standard_D16_v3",
            "Standard_D1_v2",
            "Standard_D2",
            "Standard_D2_v2",
            "Standard_D2_v2_Promo",
            "Standard_D2_v3",
            "Standard_D3",
            "Standard_D32_v3",
            "Standard_D3_v2",
            "Standard_D3_v2_Promo",
            "Standard_D4",
            "Standard_D4_v2",
            "Standard_D4_v2_Promo",
            "Standard_D4_v3",
            "Standard_D5_v2",
            "Standard_D5_v2_Promo",
            "Standard_D64_v3",
            "Standard_D8_v3",
            "Standard_E16_v3",
            "Standard_E2_v3",
            "Standard_E32_v3",
            "Standard_E4_v3",
            "Standard_E64_v3",
            "Standard_E8_v3",
            "Standard_F1",
            "Standard_F16",
            "Standard_F2",
            "Standard_F4",
            "Standard_F8",
            "Standard_G1",
            "Standard_G2",
            "Standard_G3",
            "Standard_G4",
            "Standard_G5",
            "Standard_H16",
            "Standard_H16m",
            "Standard_H16mr",
            "Standard_H16r",
            "Standard_H8",
            "Standard_H8m",
            "Standard_NC12",
            "Standard_NC24",
            "Standard_NC24r",
            "Standard_NC6",
            "Standard_NV12",
            "Standard_NV24",
            "Standard_NV6"
        ],
        "vmssStorageAccountType": "[if(contains(variables('vmssStandardLrsSize'), parameters('vmssVmSize')), 'Standard_LRS', 'Premium_LRS')]"
    },
    "resources": [
        {
            "apiVersion": "[variables('computeApiVersion')]",
            "type": "Microsoft.Compute/virtualMachineScaleSets",
            "name": "[parameters('vmssName')]",
            "location": "[parameters('location')]",
            "tags": {
                "provider": "[toUpper(parameters('GiantSwarmTags').provider)]"
            },
            "sku": {
                "name": "[parameters('vmssVmSize')]",
                "tier": "Standard",
                "capacity": "[int(parameters('vmssVmCount'))]"
            },
            "identity": {
                "type": "systemAssigned"
            },
            "properties": {
                "overprovision": "true",
                "upgradePolicy": {
                    "mode": "Manual"
                },
                "singlePlacementGroup": "[variables('vmssSinglePlacementGroup')]",
                "virtualMachineProfile": {
                    "osProfile": {
                        "adminUsername": "[parameters('vmssSshUser')]",
                        "computerNamePrefix": "[variables('vmssVmNamePrefix')]",
                        "customData": "[parameters('vmssVmCustomData')]",
                        "linuxConfiguration": {
                            "disablePasswordAuthentication": "true",
                            "ssh": {
                                "publicKeys": [
                                    {
                                        "keyData": "[parameters('vmssSshPublicKey')]",
                                        "path": "[concat('/home/', parameters('vmssSshUser'), '/.ssh/authorized_keys')]"
                                    }
                                ]
                            }
                        }
                    },
                    "storageProfile": {
                        "imageReference": {
                            "publisher": "[parameters('vmssOsImagePublisher')]",
                            "offer": "[parameters('vmssOsImageOffer')]",
                            "sku": "[parameters('vmssOsImageSKU')]",
                            "version": "[parameters('vmssOsImageVersion')]"
                        },
                        "osDisk": {
                            "caching": "ReadWrite",
                            "createOption": "FromImage",
                            "managedDisk": {
                                "storageAccountType": "[variables('vmssStorageAccountType')]"
                            }
                        },
                        "copy": [
                            {
                                "name": "dataDisks",
                                "count": "[length(parameters('vmssVmDataDisks'))]",
                                "input": {
                                    "caching": "ReadWrite",
                                    "createOption": "Empty",
                                    "diskSizeGB": "[parameters('vmssVmDataDisks')[copyIndex('dataDisks')].sizeGB]",
                                    "managedDisk": {
                                        "storageAccountType": "[variables('vmssStorageAccountType')]"
                                    },
                                    "lun": "[copyIndex('dataDisks')]"
                                }
                            }
                        ]
                    },
                    "networkProfile": {
                        "networkInterfaceConfigurations": [
                            {
                                "name": "[concat(parameters('vmssName'), '-nic')]",
                                "properties": {
                                    "enableIPForwarding": true,
                                    "primary": "true",
                                    "ipConfigurations": [
                                        {
                                            "name": "[concat(parameters('vmssName'), '-ipconfig')]",
                                            "properties": {
                                                "subnet": {
                                                    "id": "[parameters('vmssVnetSubnetId')]"
                                                },
                                                "loadBalancerBackendAddressPools": [
                                                    {
                                                        "id": "[parameters('vmssLbBackendPoolId')]"
                                                    }
                                                ]
                                            }
                                        }
                                    ]
                                }
                            }
                        ]
                    },
                    "extensionProfile": {
                        "extensions": [
                            {
                                "name": "MSILinuxExtension",
                                "properties": {
                                    "publisher": "Microsoft.ManagedIdentity",
                                    "type": "ManagedIdentityExtensionForLinux",
                                    "typeHandlerVersion": "1.0",
                                    "autoUpgradeMinorVersion": true,
                                    "settings": {
                                        "port": 50342
                                    },
                                    "protectedSettings": {}
                                }
                            }
                        ]
                    }
                }
            }
        }
    ]
}
