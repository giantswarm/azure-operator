{
  "$schema":"https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion":"1.0.0.0",
  "parameters":{
    "apiLBBackendPoolID":{
      "type":"string",
      "metadata":{
        "description":"Output value of the API load balancer backend pool ID as referenced from the API load balancer setup."
      }
    },
    "clusterID":{
      "type":"string",
      "metadata":{
        "description":"Unique ID of the guest cluster."
      }
    },
    "etcdLBBackendPoolID":{
      "type":"string",
      "metadata":{
        "description":"Output value of the Etcd load balancer backend pool ID as referenced from the Etcd load balancer setup."
      }
    },
    "GiantSwarmTags":{
      "type":"object",
      "defaultValue":{
        "provider":"F80D01C0-7AAC-4440-98F6-5061511962AD"
      }
    },
    "masterCloudConfigData":{
      "type":"secureString",
      "metadata":{
        "description":"Base64-encoded cloud-config data."
      }
    },
    "masterNodes":{
      "type":"array"
    },
    "masterSubnetID":{
      "type":"string",
      "metadata":{
        "description":"Output value of the master subnet ID as referenced from the virtual network setup."
      }
    },
    "vmssMSIEnabled":{
      "type":"bool"
    },
    "vmssTemplateFile":{
      "type":"string",
      "defaultValue":"vmss.json",
      "allowedValues": [
        "vmss.json"
      ]
    },
    "workerCloudConfigData":{
      "type":"secureString",
      "metadata":{
        "description":"Base64-encoded cloud-config data."
      }
    },
    "workerNodes":{
      "type":"array"
    },
    "workerSubnetID":{
      "type":"string",
      "metadata":{
        "description":"Output value of the worker subnet ID as referenced from the virtual network setup."
      }
    },
    "zones":{
      "type":"array",
      "defaultValue": [1],
      "metadata":{
        "description":"Availability zones used to create the cluster."
      }
    }
  },
  "variables":{
    "apiVersion":"2016-09-01",
    "kubernetesLBBackendID":"[concat(resourceId('Microsoft.Network/loadBalancers', 'kubernetes'), '/backendAddressPools/kubernetes')]",
    "vmssTemplateURI":"[uri(deployment().properties.templateLink.uri, parameters('vmssTemplateFile'))]",
    "vmssStandardLrsSize": [
      "Standard_A0",
      "Standard_A1",
      "Standard_A10",
      "Standard_A11",
      "Standard_A1_v2",
      "Standard_A2",
      "Standard_A2_v2",
      "Standard_A2m_v2",
      "Standard_A3",
      "Standard_A4",
      "Standard_A4_v2",
      "Standard_A4m_v2",
      "Standard_A5",
      "Standard_A6",
      "Standard_A7",
      "Standard_A8",
      "Standard_A8_v2",
      "Standard_A8m_v2",
      "Standard_A9",
      "Standard_D1",
      "Standard_D11",
      "Standard_D11_v2",
      "Standard_D11_v2_Promo",
      "Standard_D12",
      "Standard_D12_v2",
      "Standard_D12_v2_Promo",
      "Standard_D13",
      "Standard_D13_v2",
      "Standard_D13_v2_Promo",
      "Standard_D14",
      "Standard_D14_v2",
      "Standard_D14_v2_Promo",
      "Standard_D15_v2",
      "Standard_D16_v3",
      "Standard_D1_v2",
      "Standard_D2",
      "Standard_D2_v2",
      "Standard_D2_v2_Promo",
      "Standard_D2_v3",
      "Standard_D3",
      "Standard_D32_v3",
      "Standard_D3_v2",
      "Standard_D3_v2_Promo",
      "Standard_D4",
      "Standard_D4_v2",
      "Standard_D4_v2_Promo",
      "Standard_D4_v3",
      "Standard_D5_v2",
      "Standard_D5_v2_Promo",
      "Standard_D64_v3",
      "Standard_D8_v3",
      "Standard_E16_v3",
      "Standard_E2_v3",
      "Standard_E32_v3",
      "Standard_E4_v3",
      "Standard_E64_v3",
      "Standard_E8_v3",
      "Standard_F1",
      "Standard_F16",
      "Standard_F2",
      "Standard_F4",
      "Standard_F8",
      "Standard_G1",
      "Standard_G2",
      "Standard_G3",
      "Standard_G4",
      "Standard_G5",
      "Standard_H16",
      "Standard_H16m",
      "Standard_H16mr",
      "Standard_H16r",
      "Standard_H8",
      "Standard_H8m",
      "Standard_NC12",
      "Standard_NC24",
      "Standard_NC24r",
      "Standard_NC6",
      "Standard_NV12",
      "Standard_NV24",
      "Standard_NV6"
    ]
  },
  "resources":[
    {
      "apiVersion":"[variables('apiVersion')]",
      "type":"Microsoft.Resources/deployments",
      "name":"master-vmss-deploy",
      "properties":{
        "mode":"incremental",
        "templateLink":{
          "uri":"[variables('vmssTemplateURI')]",
          "contentVersion":"1.0.0.0"
        },
        "parameters":{
          "location":{
            "value":"[resourceGroup().location]"
          },
          "GiantSwarmTags":{
            "value":"[parameters('GiantSwarmTags')]"
          },
          "vmssName":{
            "value":"[concat(parameters('clusterID'), '-master')]"
          },
          "vmssMSIEnabled":{
            "value":"[parameters('vmssMSIEnabled')]"
          },
          "vmssVmSize":{
            "value":"[parameters('masterNodes')[0].vmSize]"
          },
          "vmssVmCount":{
            "value":"[length(parameters('masterNodes'))]"
          },
          "vmssStandardLrsSize": {
            "value": "[variables('vmssStandardLrsSize')]"
          },
          "vmssVmDataDisks":{
            "value":[
              {
                "caching": "ReadWrite",
                "createOption": "Empty",
                "diskSizeGB": 100,
                "managedDisk":
                {
                  "storageAccountType": "[if(contains(variables('vmssStandardLrsSize'), parameters('masterNodes')[0].vmSize), 'Standard_LRS', 'Premium_LRS')]"
                },
                "lun": 0
              }
            ]
          },
          "vmssSshUser":{
            "value":"[parameters('masterNodes')[0].adminUsername]"
          },
          "vmssSshPublicKey":{
            "value":"[parameters('masterNodes')[0].adminSSHKeyData]"
          },
          "vmssOsImagePublisher":{
            "value":"[parameters('masterNodes')[0].osImage.publisher]"
          },
          "vmssOsImageOffer":{
            "value":"[parameters('masterNodes')[0].osImage.offer]"
          },
          "vmssOsImageSKU":{
            "value":"[parameters('masterNodes')[0].osImage.sku]"
          },
          "vmssOsImageVersion":{
            "value":"[parameters('masterNodes')[0].osImage.version]"
          },
          "vmssOverprovision":{
            "value":"false"
          },
          "vmssVmCustomData":{
            "value":"[parameters('masterCloudConfigData')]"
          },
          "vmssLbBackendPools":{
            "value":[
              {
                "id":"[parameters('apiLBBackendPoolID')]"
              },
              {
                "id":"[parameters('etcdLBBackendPoolID')]"
              }
            ]
          },
          "vmssVnetSubnetId":{
            "value":"[parameters('masterSubnetID')]"
          },
          "vmssUpgradePolicy":{
            "value":"Manual"
          },
          "zones":{
            "value":"[parameters('zones')]"
          }
        }
      }
    },
    {
      "apiVersion":"[variables('apiVersion')]",
      "type":"Microsoft.Resources/deployments",
      "name":"worker-vmss-deploy",
      "properties":{
        "mode":"incremental",
        "templateLink":{
          "uri":"[variables('vmssTemplateURI')]",
          "contentVersion":"1.0.0.0"
        },
        "parameters":{
          "location":{
            "value":"[resourceGroup().location]"
          },
          "GiantSwarmTags":{
            "value":"[parameters('GiantSwarmTags')]"
          },
          "vmssName":{
            "value":"[concat(parameters('clusterID'), '-worker')]"
          },
          "vmssMSIEnabled":{
            "value":"[parameters('vmssMSIEnabled')]"
          },
          "vmssVmSize":{
            "value":"[parameters('workerNodes')[0].vmSize]"
          },
          "vmssVmCount":{
            "value":"[length(parameters('workerNodes'))]"
          },
          "vmssVmDataDisks":{
            "value":[
            ]
          },
          "vmssSshUser":{
            "value":"[parameters('workerNodes')[0].adminUsername]"
          },
          "vmssSshPublicKey":{
            "value":"[parameters('workerNodes')[0].adminSSHKeyData]"
          },
          "vmssOsImagePublisher":{
            "value":"[parameters('workerNodes')[0].osImage.publisher]"
          },
          "vmssOsImageOffer":{
            "value":"[parameters('workerNodes')[0].osImage.offer]"
          },
          "vmssOsImageSKU":{
            "value":"[parameters('workerNodes')[0].osImage.sku]"
          },
          "vmssOsImageVersion":{
            "value":"[parameters('workerNodes')[0].osImage.version]"
          },
          "vmssOverprovision":{
            "value":"true"
          },
          "vmssVmCustomData":{
            "value":"[parameters('workerCloudConfigData')]"
          },
          "vmssLbBackendPools":{
            "value":[
              {
                "id":"[variables('kubernetesLBBackendID')]"
              }
            ]
          },
          "vmssVnetSubnetId":{
            "value":"[parameters('workerSubnetID')]"
          },
          "vmssUpgradePolicy":{
            "value":"Manual"
          },
          "zones":{
            "value":"[parameters('zones')]"
          }
        }
      }
    }
  ]
}
