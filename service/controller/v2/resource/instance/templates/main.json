{
  "$schema":"https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion":"1.0.0.0",
  "parameters":{
    "clusterID":{
      "type":"string",
      "metadata":{
        "description":"Unique ID of this guest cluster."
      }
    },
    "GiantSwarmTags":{
      "type":"object",
      "defaultValue":{
        "provider":"F80D01C0-7AAC-4440-98F6-5061511962AD"
      }
    },
    "masterCloudConfigData":{
      "type":"secureString",
      "metadata":{
        "description":"Base64-encoded cloud-config data."
      }
    },
    "masterNodes":{
      "type":"array"
    },
    "masterVersionBundleVersions":{
      "type":"object",
      "metadata":{
        "description":"JSON blob of key-value pairs mapping master VMSS instance names to their applied version bundle versions."
      }
    },
    "templatesBaseURI":{
      "type":"string",
      "metadata":{
        "description":"The base URI from which the templates will be fetched. Ends with a trailing '/'."
      }
    },
    "vmssMSIEnabled":{
      "type":"bool"
    },
    "vmssTemplateFile":{
      "type":"string",
      "defaultValue":"vmss.json"
    },
    "workerCloudConfigData":{
      "type":"secureString",
      "metadata":{
        "description":"Base64-encoded cloud-config data."
      }
    },
    "workerNodes":{
      "type":"array"
    },
    "workerVersionBundleVersions":{
      "type":"object",
      "metadata":{
        "description":"JSON blob of key-value pairs mapping worker VMSS instance names to their applied version bundle versions."
      }
    }
  },
  "variables":{
    "kubernetesLBBackendID":"[concat(resourceId('Microsoft.Network/loadBalancers', 'kubernetes'), '/backendAddressPools/kubernetes')]",
    "vmssTemplateURI":"[concat(parameters('templatesBaseURI'), parameters('vmssTemplateFile'))]"
  },
  "resources":[
    {
      "apiVersion":"2016-09-01",
      "type":"Microsoft.Resources/deployments",
      "name":"master-vmss-deploy",
      "properties":{
        "mode":"incremental",
        "templateLink":{
          "uri":"[variables('vmssTemplateURI')]",
          "contentVersion":"1.0.0.0"
        },
        "parameters":{
          "location":{
            "value":"[resourceGroup().location]"
          },
          "GiantSwarmTags":{
            "value":"[parameters('GiantSwarmTags')]"
          },
          "versionBundleVersions":{
            "value":"[parameters('masterVersionBundleVersions')]"
          },
          "vmssName":{
            "value":"[concat(parameters('clusterID'), '-master')]"
          },
          "vmssMSIEnabled":{
            "value":"[parameters('vmssMSIEnabled')]"
          },
          "vmssVmSize":{
            "value":"[parameters('masterNodes')[0].vmSize]"
          },
          "vmssVmCount":{
            "value":"[length(parameters('masterNodes'))]"
          },
          "vmssVmDataDisks":{
            "value":[
              {
                "name":"EtcdDisk",
                "sizeGB":100
              },
              {
                "name":"DockerDisk",
                "sizeGB":50
              }
            ]
          },
          "vmssSshUser":{
            "value":"[parameters('masterNodes')[0].adminUsername]"
          },
          "vmssSshPublicKey":{
            "value":"[parameters('masterNodes')[0].adminSSHKeyData]"
          },
          "vmssOsImagePublisher":{
            "value":"[parameters('masterNodes')[0].osImage.publisher]"
          },
          "vmssOsImageOffer":{
            "value":"[parameters('masterNodes')[0].osImage.offer]"
          },
          "vmssOsImageSKU":{
            "value":"[parameters('masterNodes')[0].osImage.sku]"
          },
          "vmssOsImageVersion":{
            "value":"[parameters('masterNodes')[0].osImage.version]"
          },
          "vmssOverprovision":{
            "value":"false"
          },
          "vmssVmCustomData":{
            "value":"[parameters('masterCloudConfigData')]"
          },
          "vmssLbBackendPools":{
            "value":[
              {
                "id":"[reference('api_load_balancer_setup').outputs.backendPoolId.value]"
              },
              {
                "id":"[reference('etcd_load_balancer_setup').outputs.backendPoolId.value]"
              }
            ]
          },
          "vmssVnetSubnetId":{
            "value":"[reference('virtual_network_setup').outputs.masterSubnetID.value]"
          },
          "vmssUpgradePolicy":{
            "value":"Manual"
          }
        }
      }
    },
    {
      "apiVersion":"2016-09-01",
      "type":"Microsoft.Resources/deployments",
      "name":"worker-vmss-deploy",
      "properties":{
        "mode":"incremental",
        "templateLink":{
          "uri":"[variables('vmssTemplateURI')]",
          "contentVersion":"1.0.0.0"
        },
        "parameters":{
          "location":{
            "value":"[resourceGroup().location]"
          },
          "GiantSwarmTags":{
            "value":"[parameters('GiantSwarmTags')]"
          },
          "versionBundleVersions":{
            "value":"[parameters('workerVersionBundleVersions')]"
          },
          "vmssName":{
            "value":"[concat(parameters('clusterID'), '-worker')]"
          },
          "vmssMSIEnabled":{
            "value":"[parameters('vmssMSIEnabled')]"
          },
          "vmssVmSize":{
            "value":"[parameters('workerNodes')[0].vmSize]"
          },
          "vmssVmCount":{
            "value":"[length(parameters('workerNodes'))]"
          },
          "vmssVmDataDisks":{
            "value":[
              {
                "name":"DockerDisk",
                "sizeGB":50
              }
            ]
          },
          "vmssSshUser":{
            "value":"[parameters('workerNodes')[0].adminUsername]"
          },
          "vmssSshPublicKey":{
            "value":"[parameters('workerNodes')[0].adminSSHKeyData]"
          },
          "vmssOsImagePublisher":{
            "value":"[parameters('workerNodes')[0].osImage.publisher]"
          },
          "vmssOsImageOffer":{
            "value":"[parameters('workerNodes')[0].osImage.offer]"
          },
          "vmssOsImageSKU":{
            "value":"[parameters('workerNodes')[0].osImage.sku]"
          },
          "vmssOsImageVersion":{
            "value":"[parameters('workerNodes')[0].osImage.version]"
          },
          "vmssOverprovision":{
            "value":"true"
          },
          "vmssVmCustomData":{
            "value":"[parameters('workerCloudConfigData')]"
          },
          "vmssLbBackendPools":{
            "value":[
              {
                "id":"[variables('kubernetesLBBackendID')]"
              }
            ]
          },
          "vmssVnetSubnetId":{
            "value":"[reference('virtual_network_setup').outputs.workerSubnetID.value]"
          },
          "vmssUpgradePolicy":{
            "value":"Manual"
          }
        }
      }
    }
  ]
}
