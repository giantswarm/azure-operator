{
  "$schema":"https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion":"1.0.0.0",
  "parameters":{
    "apiLBBackendPoolID":{
      "type":"string",
      "metadata":{
        "description":"Output value of the API load balancer backend pool ID as referenced from the API load balancer setup."
      }
    },
    "clusterID":{
      "type":"string",
      "metadata":{
        "description":"Unique ID of the guest cluster."
      }
    },
    "etcdLBBackendPoolID":{
      "type":"string",
      "metadata":{
        "description":"Output value of the Etcd load balancer backend pool ID as referenced from the Etcd load balancer setup."
      }
    },
    "GiantSwarmTags":{
      "type":"object",
      "defaultValue":{
        "provider":"F80D01C0-7AAC-4440-98F6-5061511962AD"
      }
    },
    "masterCloudConfigData":{
      "type":"secureString",
      "metadata":{
        "description":"Base64-encoded cloud-config data."
      }
    },
    "masterNodes":{
      "type":"array"
    },
    "masterSubnetID":{
      "type":"string",
      "metadata":{
        "description":"Output value of the master subnet ID as referenced from the virtual network setup."
      }
    },
    "vmssMSIEnabled":{
      "type":"bool"
    },
    "vmssTemplateFile":{
      "type":"string",
      "defaultValue":"vmss.json",
      "allowedValues": [
        "vmss.json",
        "vmss-az.json"
      ]
    },
    "workerCloudConfigData":{
      "type":"secureString",
      "metadata":{
        "description":"Base64-encoded cloud-config data."
      }
    },
    "workerNodes":{
      "type":"array"
    },
    "workerSubnetID":{
      "type":"string",
      "metadata":{
        "description":"Output value of the worker subnet ID as referenced from the virtual network setup."
      }
    },
    "zones":{
      "type":"array",
      "defaultValue": [1],
      "metadata":{
        "description":"Availability zones used to create the cluster."
      }
    }
  },
  "variables":{
    "kubernetesLBBackendID":"[concat(resourceId('Microsoft.Network/loadBalancers', 'kubernetes'), '/backendAddressPools/kubernetes')]",
    "vmssTemplateURI":"[uri(deployment().properties.templateLink.uri, parameters('vmssTemplateFile'))]"
  },
  "resources":[
    {
      "apiVersion":"2016-09-01",
      "type":"Microsoft.Resources/deployments",
      "name":"master-vmss-deploy",
      "properties":{
        "mode":"incremental",
        "templateLink":{
          "uri":"[variables('vmssTemplateURI')]",
          "contentVersion":"1.0.0.0"
        },
        "parameters":{
          "location":{
            "value":"[resourceGroup().location]"
          },
          "GiantSwarmTags":{
            "value":"[parameters('GiantSwarmTags')]"
          },
          "vmssName":{
            "value":"[concat(parameters('clusterID'), '-master')]"
          },
          "vmssMSIEnabled":{
            "value":"[parameters('vmssMSIEnabled')]"
          },
          "vmssVmSize":{
            "value":"[parameters('masterNodes')[0].vmSize]"
          },
          "vmssVmCount":{
            "value":"[length(parameters('masterNodes'))]"
          },
          "vmssVmDataDisks":{
            "value":[
              {
                "name":"EtcdDisk",
                "sizeGB":100
              },
              {
                "name":"DockerDisk",
                "sizeGB":"[if(greater(parameters('masterNodes')[0].dockerVolumeSizeGB, 0), parameters('masterNodes')[0].dockerVolumeSizeGB, 50)]"
              },
              {
                "name":"KubeletDisk",
                "sizeGB":"[if(greater(parameters('masterNodes')[0].kubeletVolumeSizeGB, 0), parameters('masterNodes')[0].kubeletVolumeSizeGB, 100)]"
              }
            ]
          },
          "vmssSshUser":{
            "value":"[parameters('masterNodes')[0].adminUsername]"
          },
          "vmssSshPublicKey":{
            "value":"[parameters('masterNodes')[0].adminSSHKeyData]"
          },
          "vmssOsImagePublisher":{
            "value":"[parameters('masterNodes')[0].osImage.publisher]"
          },
          "vmssOsImageOffer":{
            "value":"[parameters('masterNodes')[0].osImage.offer]"
          },
          "vmssOsImageSKU":{
            "value":"[parameters('masterNodes')[0].osImage.sku]"
          },
          "vmssOsImageVersion":{
            "value":"[parameters('masterNodes')[0].osImage.version]"
          },
          "vmssOverprovision":{
            "value":"false"
          },
          "vmssVmCustomData":{
            "value":"[parameters('masterCloudConfigData')]"
          },
          "vmssLbBackendPools":{
            "value":[
              {
                "id":"[parameters('apiLBBackendPoolID')]"
              },
              {
                "id":"[parameters('etcdLBBackendPoolID')]"
              }
            ]
          },
          "vmssVnetSubnetId":{
            "value":"[parameters('masterSubnetID')]"
          },
          "vmssUpgradePolicy":{
            "value":"Manual"
          },
          "zones":{
            "value":"[parameters('zones')]"
          }
        }
      }
    },
    {
      "apiVersion":"2016-09-01",
      "type":"Microsoft.Resources/deployments",
      "name":"worker-vmss-deploy",
      "properties":{
        "mode":"incremental",
        "templateLink":{
          "uri":"[variables('vmssTemplateURI')]",
          "contentVersion":"1.0.0.0"
        },
        "parameters":{
          "location":{
            "value":"[resourceGroup().location]"
          },
          "GiantSwarmTags":{
            "value":"[parameters('GiantSwarmTags')]"
          },
          "vmssName":{
            "value":"[concat(parameters('clusterID'), '-worker')]"
          },
          "vmssMSIEnabled":{
            "value":"[parameters('vmssMSIEnabled')]"
          },
          "vmssVmSize":{
            "value":"[parameters('workerNodes')[0].vmSize]"
          },
          "vmssVmCount":{
            "value":"[length(parameters('workerNodes'))]"
          },
          "vmssVmDataDisks":{
            "value":[
              {
                "name":"DockerDisk",
                "sizeGB":"[if(greater(parameters('workerNodes')[0].dockerVolumeSizeGB, 0), parameters('workerNodes')[0].dockerVolumeSizeGB, 50)]"
              },
              {
                "name":"KubeletDisk",
                "sizeGB":"[if(greater(parameters('workerNodes')[0].kubeletVolumeSizeGB, 0), parameters('workerNodes')[0].kubeletVolumeSizeGB, 100)]"
              }
            ]
          },
          "vmssSshUser":{
            "value":"[parameters('workerNodes')[0].adminUsername]"
          },
          "vmssSshPublicKey":{
            "value":"[parameters('workerNodes')[0].adminSSHKeyData]"
          },
          "vmssOsImagePublisher":{
            "value":"[parameters('workerNodes')[0].osImage.publisher]"
          },
          "vmssOsImageOffer":{
            "value":"[parameters('workerNodes')[0].osImage.offer]"
          },
          "vmssOsImageSKU":{
            "value":"[parameters('workerNodes')[0].osImage.sku]"
          },
          "vmssOsImageVersion":{
            "value":"[parameters('workerNodes')[0].osImage.version]"
          },
          "vmssOverprovision":{
            "value":"true"
          },
          "vmssVmCustomData":{
            "value":"[parameters('workerCloudConfigData')]"
          },
          "vmssLbBackendPools":{
            "value":[
              {
                "id":"[variables('kubernetesLBBackendID')]"
              }
            ]
          },
          "vmssVnetSubnetId":{
            "value":"[parameters('workerSubnetID')]"
          },
          "vmssUpgradePolicy":{
            "value":"Manual"
          },
          "zones":{
            "value":"[parameters('zones')]"
          }
        }
      }
    }
  ]
}
